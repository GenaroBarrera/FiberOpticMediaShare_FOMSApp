@page "/cable/{Id:int}"
@using FOMSApp.Shared.Models
@using System.Text.Json
@using NetTopologySuite.IO.Converters
@using NetTopologySuite.Geometries
@using Microsoft.JSInterop
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Cable Details</PageTitle>

@if (cable == null)
{
    <p><em>Loading details...</em></p>
}
else
{
    <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Cable Details</h2>
            <a href="/" class="btn btn-light btn-sm">Back to Map</a>
        </div>
        <div class="card-body">
            @if (!isEditing)
            {
                <!-- View Mode -->
                <div class="mb-3">
                    <label class="form-label"><strong>Name:</strong></label>
                    <p class="mb-0">@(cable?.Name ?? "Unknown")</p>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Description:</strong></label>
                    <p class="mb-0">@(cable?.Description ?? "No description provided.")</p>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Color:</strong></label>
                    <p class="mb-0">
                        <span class="badge" style="background-color: @GetColorHex(cable?.Color ?? "Black"); color: white; padding: 0.35em 0.65em;">
                            @(cable?.Color ?? "Black")
                        </span>
                    </p>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Length:</strong></label>
                    <p class="mb-0">@GetCableLength(cable)</p>
                </div>
                <button type="button" class="btn btn-primary" @onclick="StartEditing">Edit Cable</button>
            }
            else if (editModel != null)
            {
                <!-- Edit Mode -->
                <EditForm Model="@editModel" OnValidSubmit="@SaveCable">
                    <DataAnnotationsValidator />
                    <div class="mb-3">
                        <label for="cableName" class="form-label"><strong>Name:</strong></label>
                        <InputText id="cableName" class="form-control" @bind-Value="editModel.Name" />
                        <ValidationMessage For="@(() => editModel.Name)" />
                    </div>
                    <div class="mb-3">
                        <label for="cableDescription" class="form-label"><strong>Description:</strong></label>
                        <InputTextArea id="cableDescription" class="form-control" rows="4" @bind-Value="editModel.Description" placeholder="Enter a brief description or notes about this cable..." />
                        <ValidationMessage For="@(() => editModel.Description)" />
                    </div>
                    <div class="mb-3">
                        <label for="cableColor" class="form-label"><strong>Color:</strong></label>
                        <InputSelect id="cableColor" class="form-select" @bind-Value="editModel.Color">
                            <option value="Black">Black</option>
                            <option value="Blue">Blue</option>
                            <option value="Orange">Orange</option>
                            <option value="Green">Green</option>
                            <option value="Brown">Brown</option>
                            <option value="Pink">Pink</option>
                            <option value="Teal">Teal</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => editModel.Color)" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Length:</strong></label>
                        <p class="mb-0 text-muted">@GetCableLength(cable) (calculated, cannot be changed)</p>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <text>Saving...</text>
                            }
                            else
                            {
                                <text>Save Changes</text>
                            }
                        </button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="CancelEditing" disabled="@isSaving">Cancel</button>
                    </div>
                </EditForm>
            }
        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }
    private Cable? cable;
    
    private bool isEditing = false;
    private bool isSaving = false;
    private CableEditModel? editModel;

    protected override async Task OnInitializedAsync()
    {
        await LoadCable();
    }

    private async Task LoadCable()
    {
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        options.Converters.Add(new GeoJsonConverterFactory());
        cable = await Http.GetFromJsonAsync<Cable>($"api/cables/{Id}", options);
    }

    // Calculates cable length using Haversine formula
    private string GetCableLength(Cable? cable)
    {
        if (cable?.Path == null || cable.Path.NumPoints < 2)
            return "N/A (insufficient points)";

        double totalLengthMeters = 0.0;
        var coordinates = cable.Path.Coordinates;

        for (int i = 0; i < coordinates.Length - 1; i++)
        {
            var point1 = coordinates[i];
            var point2 = coordinates[i + 1];
            
            double lat1 = point1.Y * Math.PI / 180.0;
            double lat2 = point2.Y * Math.PI / 180.0;
            double deltaLat = (point2.Y - point1.Y) * Math.PI / 180.0;
            double deltaLng = (point2.X - point1.X) * Math.PI / 180.0;

            double a = Math.Sin(deltaLat / 2) * Math.Sin(deltaLat / 2) +
                       Math.Cos(lat1) * Math.Cos(lat2) *
                       Math.Sin(deltaLng / 2) * Math.Sin(deltaLng / 2);
            double c = 2 * Math.Atan2(Math.Sqrt(a), Math.Sqrt(1 - a));
            
            const double earthRadiusMeters = 6371000.0;
            totalLengthMeters += earthRadiusMeters * c;
        }

        const double metersToFeet = 3.28084;
        double totalLengthFeet = totalLengthMeters * metersToFeet;

        if (totalLengthFeet < 5280)
            return $"{totalLengthFeet:F2} feet";
        else
            return $"{totalLengthFeet / 5280.0:F3} miles ({totalLengthFeet:F2} feet)";
    }

    // Gets hex color for display
    private string GetColorHex(string colorName) => colorName?.ToLower() switch
    {
        "black" => "#000000",
        "blue" => "#007bff",
        "orange" => "#ff8c00",
        "green" => "#28a745",
        "brown" => "#8b4513",
        "pink" => "#ff69b4",
        "teal" => "#20c997",
        _ => "#000000"
    };

    private void StartEditing()
    {
        if (cable == null) return;

        editModel = new CableEditModel
        {
            Id = cable.Id,
            Name = cable.Name ?? string.Empty,
            Description = cable.Description ?? string.Empty,
            Color = cable.Color ?? "Black"
        };

        isEditing = true;
        StateHasChanged();
    }

    private void CancelEditing()
    {
        isEditing = false;
        editModel = null;
        StateHasChanged();
    }

    private async Task SaveCable()
    {
        if (editModel == null || cable == null) return;

        isSaving = true;
        StateHasChanged();

        try
        {
            var updatedCable = new Cable
            {
                Id = editModel.Id,
                Name = editModel.Name,
                Description = string.IsNullOrWhiteSpace(editModel.Description) ? null : editModel.Description,
                Color = editModel.Color,
                Path = cable.Path
            };

            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            options.Converters.Add(new GeoJsonConverterFactory());

            var response = await Http.PutAsJsonAsync($"api/cables/{editModel.Id}", updatedCable, options);

            if (response.IsSuccessStatusCode)
            {
                await LoadCable();
                isEditing = false;
                editModel = null;
                StateHasChanged();
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Update failed: {errorMessage}");
                await JS.InvokeVoidAsync("alert", $"Failed to update cable: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating cable: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"Error updating cable: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    // Edit model for cable form
    private class CableEditModel
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string Color { get; set; } = "Black";
    }
}
