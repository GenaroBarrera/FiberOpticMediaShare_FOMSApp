@page "/midpoint/{Id:int}"
@using FOMSApp.Shared.Models
@using System.Text.Json
@using System.Net.Http.Headers
@using NetTopologySuite.IO.Converters
@using Microsoft.JSInterop
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Midpoint Details</PageTitle>

@if (midpoint == null)
{
    <p><em>Loading details...</em></p>
}
else
{
    <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Midpoint Details</h2>
            <a href="/" class="btn btn-light btn-sm">Back to Map</a>
        </div>
        <div class="card-body">
            @if (!isEditing)
            {
                <!-- View Mode -->
                <div class="mb-3">
                    <label class="form-label"><strong>Name:</strong></label>
                    <p class="mb-0">@(midpoint?.Name ?? "Unknown")</p>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Status:</strong></label>
                    <p class="mb-0">
                        <span class="badge bg-@GetStatusBadgeColor(midpoint?.Status ?? MidpointStatus.New)">@midpoint?.Status</span>
                    </p>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Description:</strong></label>
                    <p class="mb-0">@(midpoint?.Description ?? "No description provided.")</p>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Coordinates:</strong></label>
                    <p class="mb-0">
                        @if (midpoint?.Location != null)
                        {
                            @($"{midpoint.Location.Y:F6}, {midpoint.Location.X:F6}")
                            <small class="text-muted ms-2">(Lat, Lng)</small>
                        }
                        else
                        {
                            <span class="text-muted">No location set</span>
                        }
                    </p>
                </div>
                <button type="button" class="btn btn-primary" @onclick="StartEditing">Edit Midpoint</button>
            }
            else if (editModel != null)
            {
                <!-- Edit Mode -->
                <EditForm Model="@editModel" OnValidSubmit="@SaveMidpoint">
                    <DataAnnotationsValidator />
                    <div class="mb-3">
                        <label for="midpointName" class="form-label"><strong>Name:</strong></label>
                        <InputText id="midpointName" class="form-control" @bind-Value="editModel.Name" />
                        <ValidationMessage For="@(() => editModel.Name)" />
                    </div>
                    <div class="mb-3">
                        <label for="midpointStatus" class="form-label"><strong>Status:</strong></label>
                        <InputSelect id="midpointStatus" class="form-select" @bind-Value="editModel.Status">
                            <option value="@MidpointStatus.New">New</option>
                            <option value="@MidpointStatus.Review">Review</option>
                            <option value="@MidpointStatus.Complete">Complete</option>
                            <option value="@MidpointStatus.Issue">Issue</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => editModel.Status)" />
                    </div>
                    <div class="mb-3">
                        <label for="midpointDescription" class="form-label"><strong>Description:</strong></label>
                        <InputTextArea id="midpointDescription" class="form-control" rows="4" @bind-Value="editModel.Description" placeholder="Enter a brief description or notes about this midpoint..." />
                        <ValidationMessage For="@(() => editModel.Description)" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Coordinates:</strong></label>
                        <p class="mb-0 text-muted">
                            @if (midpoint?.Location != null)
                            {
                                @($"{midpoint.Location.Y:F6}, {midpoint.Location.X:F6}")
                                <small class="ms-2">(Lat, Lng - cannot be changed)</small>
                            }
                            else
                            {
                                <span>No location set (cannot be changed)</span>
                            }
                        </p>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <text>Saving...</text>
                            }
                            else
                            {
                                <text>Save Changes</text>
                            }
                        </button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="CancelEditing" disabled="@isSaving">Cancel</button>
                    </div>
                </EditForm>
            }
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Photos</h4>
            @if (photos != null && photos.Count > 0)
            {
                <button type="button" 
                        class="btn btn-success btn-sm" 
                        @onclick="DownloadAllPhotos"
                        disabled="@isDownloading"
                        title="Download all photos as a ZIP file">
                    @if (isDownloading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <text>Downloading...</text>
                    }
                    else
                    {
                        <text>â¬‡ Download All</text>
                    }
                </button>
            }
        </div>
        <div class="card-body">

            <div class="mb-3">
                <label>Select photos to upload (you can select multiple):</label>
                <div class="input-group">
                    <InputFile OnChange="@OnFilesSelected" class="form-control" accept=".jpg,.jpeg,.png" multiple @ref="fileInput" />
                </div>
                @if (selectedFiles != null && selectedFiles.Count > 0)
                {
                    <div class="mt-2">
                        <p class="mb-2">
                            <strong>Selected files:</strong> @selectedFiles.Count file(s)
                            <span class="text-muted">(@(selectedFiles.Sum(f => f.Size) / 1024) KB total)</span>
                        </p>
                        <ul class="list-group list-group-flush mb-2" style="max-height: 150px; overflow-y: auto;">
                            @foreach (var file in selectedFiles)
                            {
                                <li class="list-group-item py-1 px-2 d-flex justify-content-between align-items-center">
                                    <span>@file.Name</span>
                                    <span class="badge bg-secondary">@(file.Size / 1024) KB</span>
                                </li>
                            }
                        </ul>
                        <button type="button" class="btn btn-primary" @onclick="UploadSelectedPhotos" disabled="@(isUploading)">
                            @if (isUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <text>Uploading @uploadProgress of @selectedFiles.Count...</text>
                            }
                            else
                            {
                                <text>Upload @selectedFiles.Count Photo(s)</text>
                            }
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" @onclick="ClearSelectedFiles" disabled="@isUploading">Cancel</button>
                    </div>
                }
            </div>

            <hr />

            @if (photos == null)
            {
                <p>Loading photos...</p>
            }
            else if (photos.Count == 0)
            {
                <p class="text-muted">No photos uploaded yet.</p>
            }
            else
            {
                <div class="row">
                    @foreach (var photo in photos)
                    {
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <img src="@($"{Http.BaseAddress}api/photos/file/{Uri.EscapeDataString(photo.FileName)}")" class="card-img-top" alt="Midpoint Photo"
                                    style="max-height: 200px; object-fit: cover; cursor: pointer;"
                                    @onclick="() => OpenPhoto(photo.FileName)">
                                <div class="card-body">
                                    <small class="text-muted">Uploaded: @photo.UploadedAt.ToShortDateString()</small>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-danger" @onclick="() => DeletePhoto(photo.Id)" @onclick:stopPropagation="true">
                                            Delete Photo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    @if (selectedPhotoUrl != null)
    {
        <div class="modal-backdrop"
            style="background-color: rgba(0,0,0,0.9); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; display: flex; justify-content: center; align-items: center;"
            @onclick="ClosePhoto">
            <div style="position: relative; max-width: 90%; max-height: 90%;">
                <img src="@selectedPhotoUrl"
                    style="max-width: 100%; max-height: 90vh; border: 2px solid white; box-shadow: 0 0 20px black;" />
                <button class="btn btn-danger" style="position: absolute; top: -40px; right: 0;" @onclick="ClosePhoto">Close X</button>
            </div>
        </div>
    }
}

@code {
    [Parameter] public int Id { get; set; }
    private Midpoint? midpoint;
    private List<Photo>? photos;
    private string? selectedPhotoUrl;
    
    private bool isEditing = false;
    private bool isSaving = false;
    private MidpointEditModel? editModel;
    private InputFile? fileInput;
    private List<IBrowserFile> selectedFiles = new();
    private int uploadProgress = 0;
    private bool isUploading = false;
    private bool isDownloading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadMidpoint();
        await LoadPhotos();
    }

    private async Task LoadMidpoint()
    {
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        options.Converters.Add(new GeoJsonConverterFactory());
        midpoint = await Http.GetFromJsonAsync<Midpoint>($"api/midpoints/{Id}", options);
    }

    private async Task LoadPhotos()
    {
        photos = await Http.GetFromJsonAsync<List<Photo>>($"api/photos/midpoint/{Id}");
    }

    private void OpenPhoto(string fileName) => selectedPhotoUrl = $"{Http.BaseAddress}api/photos/file/{Uri.EscapeDataString(fileName)}";
    private void ClosePhoto() => selectedPhotoUrl = null;

    // Maps status to Bootstrap badge color
    private string GetStatusBadgeColor(MidpointStatus status) => status switch
    {
        MidpointStatus.New => "dark",
        MidpointStatus.Review => "secondary",
        MidpointStatus.Complete => "success",
        MidpointStatus.Issue => "danger",
        _ => "dark"
    };

    private void StartEditing()
    {
        if (midpoint == null) return;

        editModel = new MidpointEditModel
        {
            Id = midpoint.Id,
            Name = midpoint.Name ?? string.Empty,
            Status = midpoint.Status,
            Description = midpoint.Description ?? string.Empty
        };

        isEditing = true;
        StateHasChanged();
    }

    private void CancelEditing()
    {
        isEditing = false;
        editModel = null;
        StateHasChanged();
    }

    private async Task SaveMidpoint()
    {
        if (editModel == null || midpoint == null) return;

        isSaving = true;
        StateHasChanged();

        try
        {
            var updatedMidpoint = new Midpoint
            {
                Id = editModel.Id,
                Name = editModel.Name,
                Status = editModel.Status,
                Description = string.IsNullOrWhiteSpace(editModel.Description) ? null : editModel.Description,
                Location = midpoint.Location
            };

            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            options.Converters.Add(new GeoJsonConverterFactory());

            var response = await Http.PutAsJsonAsync($"api/midpoints/{editModel.Id}", updatedMidpoint, options);

            if (response.IsSuccessStatusCode)
            {
                await LoadMidpoint();
                isEditing = false;
                editModel = null;
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Update failed: {errorMessage}");
                await JS.InvokeVoidAsync("alert", $"Failed to update midpoint: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating midpoint: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"Error updating midpoint: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void OnFilesSelected(InputFileChangeEventArgs e)
    {
        selectedFiles = e.GetMultipleFiles(maximumFileCount: 20).ToList();
        StateHasChanged();
    }

    private void ClearSelectedFiles()
    {
        selectedFiles.Clear();
        uploadProgress = 0;
        StateHasChanged();
    }

    private async Task UploadSelectedPhotos()
    {
        if (selectedFiles.Count == 0) return;

        isUploading = true;
        uploadProgress = 0;
        StateHasChanged();

        int successCount = 0;
        int failCount = 0;
        var failedFiles = new List<string>();

        try
        {
            foreach (var file in selectedFiles)
            {
                uploadProgress++;
                StateHasChanged();

                try
                {
                    using var content = new MultipartFormDataContent();
                    var fileContent = new StreamContent(file.OpenReadStream(maxAllowedSize: 20 * 1024 * 1024));
                    fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
                    content.Add(content: fileContent, name: "file", fileName: file.Name);
                    content.Add(content: new StringContent(Id.ToString()), name: "midpointId");

                    var response = await Http.PostAsync("api/photos", content);

                    if (response.IsSuccessStatusCode)
                        successCount++;
                    else
                    {
                        failCount++;
                        failedFiles.Add(file.Name);
                        Console.WriteLine($"Upload failed for {file.Name}");
                    }
                }
                catch (Exception ex)
                {
                    failCount++;
                    failedFiles.Add(file.Name);
                    Console.WriteLine($"Error uploading {file.Name}: {ex.Message}");
                }
            }

            selectedFiles.Clear();
            uploadProgress = 0;
            await LoadPhotos();

            if (failCount > 0)
                await JS.InvokeVoidAsync("alert", $"Upload complete: {successCount} succeeded, {failCount} failed.\nFailed files: {string.Join(", ", failedFiles)}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during batch upload: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"Error during upload: {ex.Message}");
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

    private async Task DownloadAllPhotos()
    {
        if (photos == null || photos.Count == 0)
        {
            await JS.InvokeVoidAsync("alert", "No photos to download.");
            return;
        }

        isDownloading = true;
        StateHasChanged();

        try
        {
            var response = await Http.GetAsync($"api/photos/midpoint/{Id}/download");

            if (response.IsSuccessStatusCode)
            {
                var zipBytes = await response.Content.ReadAsByteArrayAsync();
                string midpointName = midpoint?.Name ?? $"Midpoint_{Id}";
                string safeMidpointName = string.Join("_", midpointName.Split(System.IO.Path.GetInvalidFileNameChars()));
                await JS.InvokeVoidAsync("downloadFile", $"{safeMidpointName}_Photos.zip", Convert.ToBase64String(zipBytes));
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
                await JS.InvokeVoidAsync("alert", "No photos found to download.");
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Failed to download photos: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading photos: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"Error downloading photos: {ex.Message}");
        }
        finally
        {
            isDownloading = false;
            StateHasChanged();
        }
    }

    private async Task DeletePhoto(int photoId)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this photo?");
        if (!confirmed) return;

        try
        {
            var response = await Http.DeleteAsync($"api/photos/{photoId}");
            if (response.IsSuccessStatusCode)
                await LoadPhotos();
            else
                await JS.InvokeAsync<string>("alert", "Failed to delete photo.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting photo: {ex.Message}");
            await JS.InvokeAsync<string>("alert", $"Error deleting photo: {ex.Message}");
        }
    }

    // Edit model for midpoint form
    private class MidpointEditModel
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public MidpointStatus Status { get; set; }
        public string? Description { get; set; }
    }
}
