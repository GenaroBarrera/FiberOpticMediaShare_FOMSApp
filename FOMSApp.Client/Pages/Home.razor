@page "/"
@using FOMSApp.Shared.Models
@using Microsoft.JSInterop
@using System.Text.Json
@using NetTopologySuite.IO.Converters
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Fiber Map</PageTitle>

<h1>Fiber Network Map</h1>

@if (vaults == null)
{
    <p><em>Loading network data...</em></p>
    <p style="font-size: small; color: gray;">(If this takes too long, check the Console (F12) for errors)</p>
}
else
{
    <div id="map" style="height: 600px; width: 100%;"></div>
}

@code {
    private Vault[]? vaults;
    private IJSObjectReference? module;
    private IJSObjectReference? mapInstance;

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            // 1. Configure the JSON Serializer to understand GeoJSON
            // Without this, the app crashes when it sees "Point" data
            var options = new JsonSerializerOptions(); 
            options.Converters.Add(new GeoJsonConverterFactory()); // Add GeoJSON support

            // 2. Fetch data using those specific options
            vaults = await Http.GetFromJsonAsync<Vault[]>("api/vaults", options);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"CRITICAL ERROR FETCHING DATA: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && vaults != null)
        {
            try 
            {
                // 3. Import the JS Helper
                module = await JS.InvokeAsync<IJSObjectReference>("import", "./mapHelper.js");

                // 4. Initialize the Map
                mapInstance = await module.InvokeAsync<IJSObjectReference>("initMap", "map");

                // 5. Loop through Vaults and add Markers
                foreach (var vault in vaults)
                {
                    if (vault.Location != null)
                    {
                        // Note: NetTopologySuite coordinates are [X, Y] (Longitude, Latitude)
                        // Leaflet needs [Latitude, Longitude]
                        double lat = vault.Location.Coordinates[1].Y;
                        double lng = vault.Location.Coordinates[0].X;

                        await module.InvokeVoidAsync("addMarker", mapInstance, lat, lng, $"<b>{vault.Name}</b><br>{vault.Status}");
                    }
                }
            }
            catch(Exception ex)
            {
                Console.WriteLine($"MAP RENDERING ERROR: {ex.Message}");
            }
        }
    }
}