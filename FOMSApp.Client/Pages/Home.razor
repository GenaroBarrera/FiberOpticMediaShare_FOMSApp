@page "/"
@using FOMSApp.Shared.Models
@using Microsoft.JSInterop
@using System.Text.Json
@using NetTopologySuite.IO.Converters
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Fiber Map</PageTitle>

<h1>Fiber Network Map</h1>

@if (vaults == null)
{
    <p><em>Loading network data...</em></p>
    <p style="font-size: small; color: gray;">(If this takes too long, check the Console (F12) for errors)</p>
}
else
{
    <div id="map" style="height: 600px; width: 100%;"></div>
}

@code {
    private Vault[]? vaults;
    private IJSObjectReference? module;
    private IJSObjectReference? mapInstance;

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            // FIX: We must enable 'PropertyNameCaseInsensitive' 
            // This allows the lowercase 'location' from the API to match the uppercase 'Location' in your C# Model.
            var options = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true 
            };
            
            // Add the GeoJSON converter so it understands Point data
            options.Converters.Add(new GeoJsonConverterFactory());

            // Fetch data using the specific options
            vaults = await Http.GetFromJsonAsync<Vault[]>("api/vaults", options);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"CRITICAL ERROR FETCHING DATA: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // LOGIC: Check if we have data (vaults) AND the map hasn't been created yet (mapInstance)
        // This ensures the map draws the moment the data arrives from the API.
        if (vaults != null && mapInstance == null)
        {
            try 
            {
                // 1. Import the JS Helper
                module = await JS.InvokeAsync<IJSObjectReference>("import", "./mapHelper.js");

                // 2. Initialize the Map
                mapInstance = await module.InvokeAsync<IJSObjectReference>("initMap", "map");

                // 3. Loop through Vaults and add Markers
                foreach (var vault in vaults)
                {
                    if (vault.Location != null)
                    {
                        // FIX: Access X and Y directly from the Point object.
                        // Do not use Coordinates[1] or Coordinates[0].
                        double lat = vault.Location.Y; // Latitude
                        double lng = vault.Location.X; // Longitude

                        // We add an HTML <a> tag that links to '/vault/{id}'
                        string popupHtml = $"<b>{vault.Name}</b><br>{vault.Status}<br><a href='vault/{vault.Id}'>View Details</a>";

                        await module.InvokeVoidAsync("addMarker", mapInstance, lat, lng, popupHtml);
                    }
                }
            }
            catch(Exception ex)
            {
                Console.WriteLine($"MAP RENDERING ERROR: {ex.Message}");
            }
        }
    }
}