@page "/"
@using FOMSApp.Shared.Models
@using Microsoft.JSInterop
@using System.Text.Json
@using NetTopologySuite.IO.Converters
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Fiber Map</PageTitle>

<h1>Fiber Network Map</h1>

@if (vaults == null || midpoints == null || cables == null)
{
    <p><em>Loading network data...</em></p>
}
else
{
    <div id="map" style="height: 600px; width: 100%;"></div>
}

@code {
    private Vault[]? vaults;
    private Midpoint[]? midpoints;
    private Cable[]? cables; // <--- The list of lines
    
    private IJSObjectReference? module;
    private IJSObjectReference? mapInstance;

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            options.Converters.Add(new GeoJsonConverterFactory());

            // Fetch all three data types
            vaults = await Http.GetFromJsonAsync<Vault[]>("api/vaults", options);
            midpoints = await Http.GetFromJsonAsync<Midpoint[]>("api/midpoints", options);
            cables = await Http.GetFromJsonAsync<Cable[]>("api/cables", options);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"DATA FETCH ERROR: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (mapInstance == null && vaults != null && midpoints != null && cables != null)
        {
            try 
            {
                module = await JS.InvokeAsync<IJSObjectReference>("import", "./mapHelper.js");
                mapInstance = await module.InvokeAsync<IJSObjectReference>("initMap", "map");

                // 1. Draw VAULTS (Pins)
                foreach (var vault in vaults)
                {
                    if (vault.Location != null)
                    {
                        string popup = $"<b>{vault.Name}</b><br>{vault.Status}<br><a href='vault/{vault.Id}'>View Details</a>";
                        await module.InvokeVoidAsync("addMarker", mapInstance, vault.Location.Y, vault.Location.X, popup);
                    }
                }

                // 2. Draw MIDPOINTS (Dots)
                foreach (var mp in midpoints)
                {
                    if (mp.Location != null)
                    {
                        await module.InvokeVoidAsync("addCircle", mapInstance, mp.Location.Y, mp.Location.X, mp.Color, $"<b>{mp.Name}</b>");
                    }
                }

                // 3. Draw CABLES (Lines)
                foreach (var cable in cables)
                {
                    if (cable.Path != null)
                    {
                        // Convert NetTopologySuite points (Lng/Lat) to Leaflet objects (Lat/Lng)
                        var latLngs = new List<object>();
                        foreach (var coord in cable.Path.Coordinates)
                        {
                            latLngs.Add(new { lat = coord.Y, lng = coord.X });
                        }

                        // Call the JS function
                        await module.InvokeVoidAsync("addPolyline", mapInstance, latLngs, cable.Color, $"<b>{cable.Name}</b>");
                    }
                }
            }
            catch(Exception ex)
            {
                Console.WriteLine($"MAP RENDER ERROR: {ex.Message}");
            }
        }
    }
}