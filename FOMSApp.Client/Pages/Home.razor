@page "/"
@using FOMSApp.Shared.Models
@using Microsoft.JSInterop
@using System.Text.Json
@using NetTopologySuite.IO.Converters
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Fiber Map</PageTitle>

<h1>Fiber Network Map</h1>

@if (vaults == null || midpoints == null)
{
    <p><em>Loading network data...</em></p>
    <p style="font-size: small; color: gray;">(If this takes too long, check the Console (F12) for errors)</p>
}
else
{
    <div id="map" style="height: 600px; width: 100%;"></div>
}

@code {
    private Vault[]? vaults;
    private Midpoint[]? midpoints; // <--- New List for Midpoints
    
    private IJSObjectReference? module;
    private IJSObjectReference? mapInstance;

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            // 1. Configure Serializer (Case Insensitive + GeoJSON)
            var options = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true 
            };
            options.Converters.Add(new GeoJsonConverterFactory());

            // 2. Fetch Vaults
            vaults = await Http.GetFromJsonAsync<Vault[]>("api/vaults", options);

            // 3. Fetch Midpoints (NEW)
            midpoints = await Http.GetFromJsonAsync<Midpoint[]>("api/midpoints", options);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"CRITICAL ERROR FETCHING DATA: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // LOGIC: Ensure data exists (vaults & midpoints) AND map is not yet created
        if (vaults != null && midpoints != null && mapInstance == null)
        {
            try 
            {
                // 1. Import the JS Helper
                module = await JS.InvokeAsync<IJSObjectReference>("import", "./mapHelper.js");

                // 2. Initialize the Map
                mapInstance = await module.InvokeAsync<IJSObjectReference>("initMap", "map");

                // 3. Draw VAULTS (Pins)
                foreach (var vault in vaults)
                {
                    if (vault.Location != null)
                    {
                        double lat = vault.Location.Y;
                        double lng = vault.Location.X;

                        // Create the "View Details" link for the popup
                        string popupHtml = $"<b>{vault.Name}</b><br>{vault.Status}<br><a href='vault/{vault.Id}'>View Details</a>";

                        // Use 'addMarker' (Teardrop Icon)
                        await module.InvokeVoidAsync("addMarker", mapInstance, lat, lng, popupHtml);
                    }
                }

                // 4. Draw MIDPOINTS (Circles) - NEW
                foreach (var mp in midpoints)
                {
                    if (mp.Location != null)
                    {
                        double lat = mp.Location.Y;
                        double lng = mp.Location.X;

                        // Use 'addCircle' (Dot Icon)
                        // We pass the specific color defined in the database (e.g., "red", "green")
                        await module.InvokeVoidAsync("addCircle", mapInstance, lat, lng, mp.Color, $"<b>{mp.Name}</b>");
                    }
                }
            }
            catch(Exception ex)
            {
                Console.WriteLine($"MAP RENDERING ERROR: {ex.Message}");
            }
        }
    }
}